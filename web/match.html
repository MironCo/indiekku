<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Indiekku - Matchmaking</title>
    <link rel="stylesheet" href="/styles.css">
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
</head>
<body>
    <header>
        <div class="header-content">
            <h1>indiekku</h1>
            <span class="subtitle">Matchmaking</span>
        </div>
        <nav class="nav-links" id="navLinks" style="display: none;">
            <a href="/" class="nav-link">DASHBOARD</a>
            <a href="/deploy" class="nav-link">DEPLOY</a>
            <a href="/logs" class="nav-link">LOGS</a>
            <a href="/history" class="nav-link">HISTORY</a>
            <a href="/match" class="nav-link active">MATCH</a>
            <button class="logout-btn" id="logoutBtn">LOGOUT</button>
        </nav>
    </header>

    <div class="container">
        <!-- Login Page -->
        <div class="login-page" id="loginPage">
            <div class="login-box">
                <h2 style="margin-bottom: 1.5rem;">Login</h2>
                <div id="authMessage" class="message"></div>
                <form id="authForm">
                    <label for="apiKey">API Key</label>
                    <input
                        type="password"
                        id="apiKey"
                        name="apiKey"
                        placeholder="Enter your API key"
                        required
                    >
                    <button type="submit">Login</button>
                </form>
            </div>
        </div>

        <!-- Match Dashboard -->
        <div class="dashboard" id="dashboard">
            <div id="matchMessage" class="message"></div>

            <!-- Config Section -->
            <div class="servers-section" style="margin-bottom: 2rem;">
                <h2 style="margin-bottom: 1rem;">Configuration</h2>
                <div id="configGrid" class="match-config-grid">
                    <div class="config-card">
                        <div class="config-label">Public IP</div>
                        <div class="config-value" id="cfgPublicIP">—</div>
                    </div>
                    <div class="config-card">
                        <div class="config-label">Match Port</div>
                        <div class="config-value" id="cfgMatchPort">—</div>
                    </div>
                    <div class="config-card">
                        <div class="config-label">Token Secret</div>
                        <div class="config-value" id="cfgTokenSecret">—</div>
                    </div>
                </div>

                <!-- Endpoint copy box -->
                <div style="margin-top: 1.5rem;">
                    <div class="config-label" style="margin-bottom: 0.5rem;">Match Endpoint</div>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <input type="text" id="matchEndpoint" readonly
                            style="flex: 1; padding: 0.6rem 0.75rem; border: 2px solid #000; background: #fafafa; font-family: monospace; font-size: 0.9rem; cursor: text;">
                        <button onclick="copyEndpoint()" style="width: auto; padding: 0.6rem 1.25rem;">Copy</button>
                    </div>
                </div>
            </div>

            <!-- Live Servers Section -->
            <div class="servers-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2 style="margin-bottom: 0;">Live Servers</h2>
                    <button onclick="loadMatchServers()" style="width: auto;">Refresh</button>
                </div>
                <div id="matchServersTable"></div>
            </div>
        </div>
    </div>

    <style>
        .match-config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
        }

        .config-card {
            border: 2px solid #000;
            padding: 1rem 1.25rem;
        }

        .config-label {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: rgba(0,0,0,0.5);
            margin-bottom: 0.35rem;
        }

        .config-value {
            font-size: 1.1rem;
            font-weight: 600;
            font-family: monospace;
            word-break: break-all;
        }

        .badge {
            display: inline-block;
            padding: 0.15rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            border: 1.5px solid;
        }

        .badge-ok   { border-color: #2a7a2a; color: #2a7a2a; }
        .badge-warn { border-color: #a07000; color: #a07000; }
        .badge-full { border-color: #c00; color: #c00; }
    </style>

    <script>
        let apiKey = '';
        let isAuthenticated = false;

        const storedKey = localStorage.getItem('indiekku_api_key');
        if (storedKey) {
            apiKey = storedKey;
            verifyAuth();
        }

        document.getElementById('authForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            apiKey = document.getElementById('apiKey').value;
            await verifyAuth();
        });

        async function verifyAuth() {
            try {
                const response = await fetch('/api/v1/servers', {
                    headers: { 'Authorization': 'Bearer ' + apiKey }
                });
                if (response.ok) {
                    localStorage.setItem('indiekku_api_key', apiKey);
                    setAuthenticated(true);
                } else {
                    setAuthenticated(false);
                    showMessage('authMessage', 'Invalid API key', 'error');
                    localStorage.removeItem('indiekku_api_key');
                }
            } catch {
                setAuthenticated(false);
                showMessage('authMessage', 'Failed to verify authentication', 'error');
            }
        }

        function setAuthenticated(authenticated) {
            isAuthenticated = authenticated;
            document.getElementById('loginPage').classList.toggle('hidden', authenticated);
            document.getElementById('dashboard').classList.toggle('visible', authenticated);
            document.getElementById('navLinks').style.display = authenticated ? 'flex' : 'none';
            if (authenticated) {
                loadConfig();
                loadMatchServers();
            }
        }

        async function loadConfig() {
            try {
                const resp = await fetch('/api/v1/matchmaking/config', {
                    headers: { 'Authorization': 'Bearer ' + apiKey }
                });
                if (!resp.ok) {
                    showMessage('matchMessage', 'Could not load matchmaking config', 'error');
                    return;
                }
                const cfg = await resp.json();
                document.getElementById('cfgPublicIP').textContent    = cfg.public_ip    || '(not set)';
                document.getElementById('cfgMatchPort').textContent   = cfg.match_port   || '—';
                document.getElementById('cfgTokenSecret').textContent = cfg.token_secret_status || '—';
                document.getElementById('matchEndpoint').value =
                    `http://${cfg.public_ip || window.location.hostname}:${cfg.match_port}`;
            } catch {
                showMessage('matchMessage', 'Error loading config', 'error');
            }
        }

        async function loadMatchServers() {
            const container = document.getElementById('matchServersTable');
            container.innerHTML = '<div class="no-servers">Loading...</div>';
            try {
                const resp = await fetch('/match-proxy/servers');
                if (!resp.ok) {
                    container.innerHTML = '<div class="no-servers">Matchmaking server unavailable</div>';
                    return;
                }
                const data = await resp.json();
                displayMatchServers(data.servers || []);
            } catch {
                container.innerHTML = '<div class="no-servers">Could not reach matchmaking server</div>';
            }
        }

        function displayMatchServers(servers) {
            const container = document.getElementById('matchServersTable');
            if (!servers.length) {
                container.innerHTML = '<div class="no-servers">No servers running</div>';
                return;
            }
            container.innerHTML = `
                <table class="servers-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Port</th>
                            <th>Players</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${servers.map(s => {
                            const full = s.full;
                            const badge = full
                                ? '<span class="badge badge-full">Full</span>'
                                : '<span class="badge badge-ok">Open</span>';
                            return `
                                <tr>
                                    <td class="server-name">${escapeHtml(s.container_name)}</td>
                                    <td class="server-port">${escapeHtml(s.port)}</td>
                                    <td class="server-players">${s.player_count}</td>
                                    <td>${badge}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        function copyEndpoint() {
            const val = document.getElementById('matchEndpoint').value;
            navigator.clipboard.writeText(val).then(() => {
                showMessage('matchMessage', 'Endpoint copied!', 'success');
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = String(text);
            return div.innerHTML;
        }

        function showMessage(elementId, text, type) {
            const el = document.getElementById(elementId);
            el.textContent = text;
            el.className = 'message show ' + type;
            setTimeout(() => el.classList.remove('show'), 5000);
        }

        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.removeItem('indiekku_api_key');
            apiKey = '';
            setAuthenticated(false);
        });
    </script>
</body>
</html>
